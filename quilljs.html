<html>
  <head>
    <!-- Include stylesheet -->
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <!-- sematic stylesheet -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css"
    />
  </head>
  <body>
    <!-- Create toolbar -->
    <div id="toolbar" class="ui top attached menu">
      <!-- Font type choice -->
      <span class="ql-formats">
        <select class="ql-font">
          <option selected="selected"></option>
          <option value="serif"></option>
          <option value="monospace"></option>
        </select>
      </span>

      <!-- font size options -->
      <span class="ql-formats">
        <select class="ql-size">
          <option value="small"></option>
          <option value="normal"></option>
          <option value="large"></option>
          <option value="huge"></option>
        </select>
      </span>

      <!-- text colour and background colour ie highlight -->
      <span class="ql-formats">
        <select class="ql-color">
          <option selected="selected"></option>
          <option value="#e60000"></option>
          <option value="#ff9900"></option>
          <option value="#ffff00"></option>
          <option value="#008a00"></option>
          <option value="#0066cc"></option>
          <option value="#9933ff"></option>
          <option value="#ffffff"></option>
          <option value="#facccc"></option>
          <option value="#ffebcc"></option>
          <option value="#ffffcc"></option>
          <option value="#cce8cc"></option>
          <option value="#cce0f5"></option>
          <option value="#ebd6ff"></option>
          <option value="#bbbbbb"></option>
          <option value="#f06666"></option>
          <option value="#ffc266"></option>
          <option value="#ffff66"></option>
          <option value="#66b966"></option>
          <option value="#66a3e0"></option>
          <option value="#c285ff"></option>
          <option value="#888888"></option>
          <option value="#a10000"></option>
          <option value="#b26b00"></option>
          <option value="#b2b200"></option>
          <option value="#006100"></option>
          <option value="#0047b2"></option>
          <option value="#6b24b2"></option>
          <option value="#444444"></option>
          <option value="#5c0000"></option>
          <option value="#663d00"></option>
          <option value="#666600"></option>
          <option value="#003700"></option>
          <option value="#002966"></option>
          <option value="#3d1466"></option>
        </select>
        <select class="ql-background">
          <option value="#000000"></option>
          <option value="#e60000"></option>
          <option value="#ff9900"></option>
          <option value="#ffff00"></option>
          <option value="#008a00"></option>
          <option value="#0066cc"></option>
          <option value="#9933ff"></option>
          <option selected="selected"></option>
          <option value="#facccc"></option>
          <option value="#ffebcc"></option>
          <option value="#ffffcc"></option>
          <option value="#cce8cc"></option>
          <option value="#cce0f5"></option>
          <option value="#ebd6ff"></option>
          <option value="#bbbbbb"></option>
          <option value="#f06666"></option>
          <option value="#ffc266"></option>
          <option value="#ffff66"></option>
          <option value="#66b966"></option>
          <option value="#66a3e0"></option>
          <option value="#c285ff"></option>
          <option value="#888888"></option>
          <option value="#a10000"></option>
          <option value="#b26b00"></option>
          <option value="#b2b200"></option>
          <option value="#006100"></option>
          <option value="#0047b2"></option>
          <option value="#6b24b2"></option>
          <option value="#444444"></option>
          <option value="#5c0000"></option>
          <option value="#663d00"></option>
          <option value="#666600"></option>
          <option value="#003700"></option>
          <option value="#002966"></option>
          <option value="#3d1466"></option>
        </select>
      </span>

      <!-- font styling eg bold -->
      <span class="ql-formats">
        <button type="button" class="ql-bold"></button>
        <button type="button" class="ql-italic"></button>
        <button type="button" class="ql-underline"></button>
      </span>

      <!-- misc formatting eg super script etc -->
      <span class="ql-formats">
        <button type="button" class="ql-blockquote"></button>
        <button type="button" class="ql-code-block"></button>
        <button type="button" class="ql-strike"></button>
        <button type="button" class="ql-script" value="sub"></button>
        <button type="button" class="ql-script" value="super"></button>
      </span>

      <!-- list type eg bullet -->
      <span class="ql-formats">
        <button type="button" class="ql-list" value="ordered"></button>
        <button type="button" class="ql-list" value="bullet"></button>
      </span>

      <!-- indent out or in -->
      <span class="ql-formats">
        <button type="button" class="ql-indent" value="-1"></button>
        <button type="button" class="ql-indent" value="+1"></button>
      </span>

      <!-- text block position eg right left etc -->
      <span class="ql-formats">
        <select class="ql-align" style="display: none;">
          <option selected="selected"></option>
          <option value="center"></option>
          <option value="right"></option>
          <option value="justify"></option>
        </select>
      </span>

      <!-- text block position eg right left etc -->
      <span class="ql-formats">
        <button type="button" class="ql-link"></button>
      </span>

      <!-- custom buttons -->
      <spn class="ql-formats">
        <button id="personFormatBtn"><i class="user plus icon"></i></button>
        <button id="menuTest">menu</button>
      </spn>
    </div>

    <!-- Create the editor container -->
    <div div class="ui bottom attached segment pusher" id="sideBarSegment">
      <!-- side menu -->
      <div class="ui inverted right vertical sidebar menu" id="sideBar">
        <div class="item">
          <form class="ui inverted form">
            <div class="ui grid">
              <div class="left floated ten wide column">
                <h4 class="ui inverted dividing header">
                  Person Tag Info
                </h4>
              </div>
              <div class="right floated right aligned six wide column">
                <i class="close link icon" id="sideMenuCloseBtn"></i>
              </div>
              <div class="ui row"></div>
            </div>

            <div class="field">
              <label>Display Text</label>
              <input type="text" name="personNameTxtBx" id="personNameTxtBx" />
              <input
                type="hidden"
                name="isSelectedPerson"
                id="isSelectedPerson"
              />
              <input type="hidden" name="rangeIndex" id="rangeIndex" />
            </div>
            <button class="ui button" id="personSaveBtn" type="button">
              Save
            </button>
          </form>
        </div>
      </div>
      <!-- editor -->
      <div class="pushable">
        <div id="editor">
          <p>Hello World!</p>
          <p>Some initial <strong>bold</strong> text</p>
        </div>
      </div>
    </div>

    <!-- person popout -->
    <div class="ui custom popup bottom right">
      <div class="ui grid">
        <form class="ui form">
          <div class="inline field">
            <label>Person:</label>
            <input type="text" name="personPopupTxt" id="personPopupTxt" />
          </div>
          <div class="inline field">
            <label>Notes:</label>
            <input
              type="textArea"
              name="personPopupNotes"
              id="personPopupNotes"
            />
          </div>
          <div class="inline disabled field">
            <label>Date:</label>
            <input type="text" name="personPopupDate" id="personPopupTxtDate" />
          </div>
          <div class="inline field">
            <label>Other Tags:</label>
            <div
              class="ui fluid multiple search dropdown"
              name="personPopoutTagsDrpDwn"
              id="personPopoutTagsDrpDwn"
            >
              <input
                type="hidden"
                name="personPopupTags"
                id="personPopupTags"
              />
              <i class="dropdown icon"></i>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Jquery -->
    <script
      src="https://code.jquery.com/jquery-3.4.0.min.js"
      integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
      crossorigin="anonymous"
    ></script>
    <!-- Include semantic JS libary -->
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Initialize Quill editor -->
    <script>
      // import Quill from 'quill'
      let Inline = Quill.import("blots/inline");
      let Delta = Quill.import("delta");
      let personTags = new Map();

      /*
        This is the basic format of the tag.
      */
      class PersonBlot extends Inline {
        static create(value) {
          let node = super.create(value);

          node.setAttribute("class", "ui small teal basic label");
          node.setAttribute("onclick", "personTag(this)");
          node.innerHTML =
            '<img src="https://img.icons8.com/ios-glyphs/30/008080/human-head.png">';

          return node;
        }

        static formats(domNode) {
          return domNode.getAttribute("class");
        }
      }

      PersonBlot.blotName = "person";
      PersonBlot.tagName = "button";

      Quill.register(PersonBlot);

      var toolbarOptions = [
        [{ font: [] }],
        [{ size: ["small", "normal", "large", "huge"] }], // custom dropdown
        [{ color: [] }, { background: [] }], // dropdown with defaults from theme
        ["bold", "italic", "underline"], // toggled buttons

        [
          "blockquote",
          "code-block",
          "strike",
          { script: "sub" },
          { script: "super" }
        ],

        [{ list: "ordered" }, { list: "bullet" }], // superscript/subscript
        [{ indent: "-1" }, { indent: "+1" }], // outdent/indent
        [{ align: [] }]
      ];

      var quill = new Quill("#editor", {
        modules: {
          toolbar: "#toolbar"
        },
        theme: "snow"
      });

      function person() {
        let word = $("#personNameTxtBx").val();
        let isSelected = $("#isSelectedPerson").val();
        let rangeIndex = $("#rangeIndex").val();

        if (isSelected == "true") {
          quill.deleteText(rangeIndex, word.length);
          quill.insertText(rangeIndex, word + " ");
        } else if (isSelected == "false") {
          quill.insertText(rangeIndex, word + " ");
        }

        quill.formatText(rangeIndex, word.length, "person", true);

        quill.setSelection(
          rangeIndex + word.length + 2,
          rangeIndex + word.length + 2
        );

        let person = {
          tag: word,
          notes: "some data to go with this",
          date: Date.now,
          page: "main",
          additionTags: "tag1,tag2"
        };
        personTags.set(word, person);
      }

      $("#personFormatBtn").on("click", function() {
        let range = quill.getSelection();

        if (range) {
          if (range.length == 0) {
            console.log("No word selected");
            $("#personNameTxtBx").val("");
            $("#isSelectedPerson").val("false");
          } else {
            $("#personNameTxtBx").val(quill.getText(range.index, range.length));
            $("#isSelectedPerson").val("true");
          }

          $("#rangeIndex").val(range.index);

          $("#sideBar")
            .sidebar({
              context: "#sideBarSegment"
            })
            .sidebar("toggle");
        } else {
          console.log("Cursor error");
        }
      });

      $("#personSaveBtn").on("click", function() {
        person();

        $("#sideBar")
          .sidebar({
            context: "#sideBarSegment"
          })
          .sidebar("toggle");
      });

      $("#sideMenuCloseBtn").on("click", function() {
        $("#sideBar")
          .sidebar({
            context: "#sideBarSegment"
          })
          .sidebar("toggle");
      });

      function personTag(tag) {
        let person = personTags.get(tag.innerText);
        let dropDownData = "[";
        let tags = person.additionTags;
        let tagsList = tags.split(",");

        tagsList.forEach(element => {
          dropDownData += "{ name: " + element + ", value: " + element + "},";
        });

        let temp = dropDownData.substr(0, dropDownData.lastIndexOf(",") - 1);

        dropDownData = JSON.parse(temp + "]");

        $("#personPopoutTagsDrpDwn").dropdown({
          values: dropDownData
        });
      }
    </script>
  </body>
</html>
